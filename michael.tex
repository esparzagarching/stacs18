\newcommand{\pn}{\mathcal{N}}
\newcommand{\norm}[1]{\lVert#1\rVert}
\newcommand{\pre}[1]{\ensuremath{{^\bullet #1}}}
\newcommand{\post}[1]{\ensuremath{{#1^\bullet}}}
\newcommand{\prepost}[1]{\ensuremath{{^\bullet {#1} ^\bullet}}}
\theoremstyle{plain}
\newtheorem{proposition}[theorem]{Proposition}

\begin{proposition}\label{prop:short:saturation}
  Let $\pn = (P, T, W)$ be a Petri net, let $\vec{x}, \vec{y} \in
  \N^P$ and let $\pi \in T^*$ be such that $\vec{x} \trans{\pi}
  \vec{y}$. Let $c \defeq \norm{W} + 1$. There exist $\vec{x}',
  \vec{y}' \in \N^P$ and $S \subseteq \{t_1, t_2, \ldots, t_n\} =
  \supp{\pi}$ such that
  \begin{itemize}
  \item $\vec{x}' \trans{t_1^{c^{n-1}} t_2^{c^{n-2}} \cdots\ t_n}
    \vec{y}'$,

  \item $n \leq |\post{S}|$,

  \item $\norm{\vec{x}'} \leq c^n$,

  \item $\supp{\vec{x}'} = \supp{\vec{x}}$, and 

  \item $\supp{\vec{y}'} = \supp{\vec{x}} \cup \post{S}$.
  \end{itemize}
\end{proposition}

\begin{proof}
  Let $\vec{x}, \vec{y} \in \N^P$ and $\pi \in T^*$ be such that
  $\vec{x} \trans{\pi} \vec{y}$. We prove the claim by induction on
  $|\pi|$. If $|\pi| = 0$, then $\supp{\pi} = \emptyset$ and $\vec{x}
  = \vec{y}$. Thus, the claim is satisfied by $S \defeq \emptyset$ and
  the markings $\vec{x}'$ and $\vec{y}'$ such that for every $p \in
  P$,
  $$
  \vec{x}'(p) \defeq \vec{y}'(p) \defeq
  \begin{cases}
    1 & \text{if } p \in \supp{\vec{x}}, \\
    0 & \text{otherwise}.
  \end{cases}
  $$ Assume that $|\pi| > 0$ and that the claim holds for sequences of
  length less than $|\pi|$. There exist $\sigma \in T^*$, $t \in T$
  and $\vec{z} \in \N^P$ such that $\pi = \sigma t$ and $\vec{x}
  \trans{\sigma} \vec{z} \trans{t} \vec{y}$. By induction hypothesis,
  there exist $\vec{x}'', \vec{z}'' \in \N^P$ and $U = \{t_1, t_2,
  \ldots, t_m\} \subseteq \supp{\sigma}$ such that
  \begin{itemize}
  \item $\vec{x}'' \trans{t_1^{c^{m-1}} t_2^{c^{m-2}} \cdots\ t_m}
    \vec{z}''$,

  \item $m \leq |\post{U}|$,

  \item $\norm{\vec{x}''} \leq c^m$,

  \item $\supp{\vec{x}''} = \supp{\vec{x}}$, and 

  \item $\supp{\vec{z}''} = \supp{\vec{x}} \cup \post{U}$.
  \end{itemize}
  
  If $\post{t} \subseteq \post{U}$, then $\post{S} = \post{U}$ and
  hence we are done by taking $\vec{x}' \defeq \vec{x}''$ and
  $\vec{y}' \defeq \vec{z}''$. Therefore, we may assume that $\post{t}
  \not\subseteq \post{U}$. Note that $\supp{\vec{z}} \subseteq
  \supp{\vec{x}} \cup \post{U} = \supp{\vec{z}''}$. Thus, since $t$ is
  enabled in $\vec{z}$ and since $t$ consumes at most $c - 1$ tokens,
  it is also enabled in $(c - 1) \cdot \vec{z}''$. Moreover, we
  have $$c \cdot \vec{x}'' \trans{t_1^{c^m} t_2^{c^{m-1}} \cdots
    t_m^c} c \cdot \vec{z}''.$$ We obtain $c \cdot \vec{x}''
  \trans{t_1^{c^m} t_2^{c^{m-1}} \cdots t_m^c} c \cdot \vec{z}''
  \trans{t} (\vec{z}'' + \vec{w})$ for some $\vec{w} \in \N^P$.  We
  claim that we are done by taking $S \defeq \{t_1, t_2, \ldots, t_n,
  t\}$, $\vec{x}' \defeq c \cdot \vec{x}''$ and $\vec{y}' \defeq
  \vec{z}'' + \vec{w}$. Let $n \defeq |S|$. The first property of
  the claim holds since
  $$c \cdot \vec{x}'' \trans{t_1^{c^{n-1}} t_2^{c^{n-2}} \cdots t_m^c
    t} \vec{y}'.$$ The second property holds since $n = m + 1 \leq
  |\post{U}| + 1 = |\post{S}|$. The third property holds since
  $\norm{\vec{x}'} = c \cdot \norm{\vec{x}''} \leq c \cdot c^m =
  c^{m+1} = c^n$. The fourth property holds since $\supp{\vec{x}'} =
  \supp{c \cdot \vec{x}''} = \supp{\vec{x}''} =
  \supp{\vec{x}}$. Finally, the fifth proprety holds since
  \begin{align*}
    \supp{\vec{y}'}
    &= \supp{\vec{z}'' + \vec{w}} \\
    &= \supp{\vec{z}''} \cup \supp{\vec{w}} \\
    &= \supp{\vec{x}} \cup \post{U} \cup \supp{\vec{w}} \\ 
    &= \supp{\vec{x}} \cup \post{U} \cup \post{t}. \\ 
    &= \supp{\vec{x}} \cup \post{S}.\qedhere
  \end{align*}
\end{proof}

\begin{corollary}\label{prop:short:cover}
  Let $\pn = (P, T, W)$ be a Petri net, let $\vec{x}, \vec{y} \in
  \N^P$, let $c \defeq \norm{W} + 1$ and let $d \defeq \norm{y}$. If
  $\vec{y}$ is coverable from $\vec{x}$, then $\vec{y}$ is coverable
  from some $\vec{x}' \in \N^P$ such that $\supp{\vec{x}'} =
  \supp{\vec{x}}$ and $\norm{\vec{x}'} \leq d \cdot c^{|P|}$, through
  a sequence $\pi$ of length less than $d \cdot c^{|P|}$.
\end{corollary}

\begin{proof}
  Assume $\vec{y}$ is coverable from $\vec{x}$. There exists some
  marking $\vec{w} \geq \vec{y}$ such that $\vec{x} \trans{*}
  \vec{w}$. By Proposition~\ref{prop:short:saturation}, there exist
  $\vec{v}, \vec{w}' \in \N^P$ and $S = \{t_1, t_2, \ldots, t_n\}
  \subseteq T$ such that
  \begin{itemize}
  \item $\vec{v} \trans{t_1^{c^{n-1}} t_2^{c^{n-2}} \cdots\ t_n}
    \vec{w}'$,

  \item $n \leq |\post{S}| \leq |P|$,

  \item $\norm{\vec{v}} \leq c^n$,

  \item $\supp{\vec{v}} = \supp{\vec{x}}$, and 

  \item $\supp{\vec{w}'} = \supp{\vec{x}} \cup \post{S}$.
  \end{itemize}

  Let $\vec{x}' \defeq d \cdot \vec{v}$, $\vec{y}' \defeq d \cdot
  \vec{w}'$, and $\pi \defeq t_1^{d \cdot c^{n-1}} t_2^{d \cdot
    c^{n-2}} \cdots\ t_n^{d}$. We have $\vec{x}' \trans{\pi}
  \vec{y}'$, $\supp{\vec{x}'} = \supp{\vec{v}} = \supp{\vec{x}}$ and
  $\norm{\vec{x}'} \leq d \cdot c^n$. Moreover, we have $\vec{y} \leq
  \vec{y}'$ since $\supp{\vec{y}} \subseteq \supp{\vec{w}} \subseteq
  \supp{\vec{x}} \cup \post{S} = \supp{\vec{w}'} = \supp{\vec{y}'}$
  and $\vec{y}'(p) \geq d$ for every $p \in \supp{\vec{y}'}$. To
  conclude the proof, observe that $|\pi| < d \cdot c^n$.
\end{proof}

\begin{theorem}
  Let $\PP$ be an ``agents know''-population protocol without
  leader. If $\PP$ computes the predicate $x \geq c$, then $\PP$ has
  at least $\log_3 c$ states.
\end{theorem}

\begin{proof}
  Assume $\PP = (Q, T, \Sigma, I, O)$ computes the predicate $x \geq
  c$. Let $R \subseteq Q$ be the set of ``know-states'' of $\PP$. Let
  $\pn = (Q, T, W)$ be the Petri net associated to $\PP$. There exists
  $q \in R$ such that $\multiset{q}$ is coverable from $\multiset{c
    \cdot x}$ in $\pn$. Note that $\norm{W} \leq 2$. Thus, by
  Corollary~\ref{prop:short:cover}, there exist $\lambda \leq 3^{|Q|}$
  and a marking $\vec{y} \geq \multiset{q}$ such that
  $\multiset{\lambda \cdot x} \trans{*} \vec{y}$. Since $\vec{y}(q) >
  0$, $\PP$ stabilizes to true on input $\multiset{\lambda \cdot
    x}$. This implies that $\lambda \geq c$ and hence that $3^{|Q|}
  \geq c$. Therefore, $|Q| \geq \log_3 c$.
\end{proof}

\begin{theorem}
  Let $\PP$ be an ``agents know''-population protocol with leader. If
  $\PP$ computes the predicate $x \geq c$, then $\PP$ has at least
  $(\log \log(c / 2) / (k \cdot 3^{1 / k}))^{k / (k + 1)}$ states for
  every $k \in \N_{>0}$. \michael{We could also fix $k = 1$ and simply
    have a square root. Depends how precise vs. cryptic we want to
    be.}
\end{theorem}

\begin{proof}
  Assume $\PP = (Q, T, \Sigma, I, O)$ computes the predicate $x \geq
  c$. Let $R \subseteq Q$ be the set of ``know-states'' of $\PP$. Let
  $\pn = (Q, T, W)$ be the Petri net associated to $\PP$. There exist
  $p, q \in Q$ and $r \in R$ such that $\multiset{q, r}$ is coverable
  from $\multiset{p, c \cdot x}$. By~\cite{Rac78}, if a marking
  $\vec{y}$ is coverable from a marking $\vec{x}$, then it is
  coverable from a sequence of length at most $2^{{(3 \cdot |Q| \cdot
      \log \norm{\vec{y}})}^{|Q| \cdot \log
      \norm{\vec{y}}}}$. Therefore, there exist $\pi \in T^*$ and
  $\vec{z} \geq \multiset{q, r}$ such that $\multiset{p, c \cdot x}
  \trans{\pi} \vec{z}$ and $|\pi| \leq 2^{(3 \cdot |Q|)^{|Q|}}$.

  We claim that $c \leq 2 \cdot |\pi|$. For the sake of contradiction,
  assume that $c > 2 \cdot |\pi|$. Note that $\pi$ consumes at most $2
  \cdot |\pi|$ tokens from place $x$. Therefore, $\pi$ is enabled at
  $\multiset{p, (c - 1) \cdot x}$. Let $\vec{z}' \defeq \vec{z} -
  \multiset{x}$. We obtain $\multiset{p, (c-1) \cdot x} \trans{\pi}
  \vec{z}'$. Since $x \not\in R$, we have $\vec{z}'(q) > 0$. Thus,
  $\PP$ stabilizes to true from $\multiset{p, (c-1) \cdot x}$, which
  is a contradiction.

  Therefore, $c \leq 2 \cdot |\pi| \leq 2 \cdot 2^{(3 \cdot
    |Q|)^{|Q|}} = 2 \cdot 2^{2^{|Q| \cdot \log(3 \cdot |Q|)}}$. This
  implies that $\log \log (c / 2) \leq |Q| \cdot \log(3 \cdot
  |Q|)$. Let $k \in \N_{>0}$. Note that $\log(3 \cdot |Q|) \leq k
  \cdot (3 \cdot |Q|)^{1 / k}$. Thus, we have $(\log \log(c / 2) / (k
  \cdot 3^{1 / k}))^{k / (k + 1)} \leq |Q|$.
\end{proof}


